Orchestrator (ศูนย์บัญชาการ)

หน้าที่
	•	รับ request จากภายนอก
	•	generate / propagate X-Correlation-ID
	•	เรียก Technical / Fundamental Agent
	•	normalize response schema
	•	ส่งผลรวมให้ Learning Agent

โปรเจกต์นี้คือระบบ "Orchestrator" สำหรับการซื้อขายสินทรัพย์อัตโนมัติ ที่ทำหน้าที่เป็นศูนย์กลางในการรวบรวมข้อมูล, วิเคราะห์, จัดการความเสี่ยง, และส่งคำสั่งซื้อขาย โดยมี Flow การทำงานหลัก 2 รูปแบบคือ:

1. การวิเคราะห์สินทรัพย์เดียว (/analyze)

รับ Request: ระบบรับ ticker (ชื่อย่อสินทรัพย์) และ account_id ที่ต้องการวิเคราะห์
ดึงข้อมูลบัญชี: ติดต่อ Database-Agent เพื่อดึงข้อมูลทางการเงินล่าสุดของบัญชี เช่น เงินสดคงเหลือ, รายการสินทรัพย์ที่ถืออยู่ (positions)
รวบรวมข้อมูลวิเคราะห์: ส่ง ticker ไปให้ Technical-Agent และ Fundamental-Agent ทำงานพร้อมกัน (concurrently) เพื่อวิเคราะห์ในมุมของแต่ละ Agent
แปลงข้อมูล (Normalize): นำผลลัพธ์ที่ได้จาก Agent ทั้งสองมาแปลงให้อยู่ในรูปแบบข้อมูลมาตรฐาน (Canonical Model) ที่ระบบเข้าใจตรงกัน
สังเคราะห์ผลลัพธ์ (Synthesize): นำข้อมูลที่แปลงแล้วมาคำนวณเพื่อให้ได้ "Final Verdict" (เช่น "buy", "sell", "hold") โดยมีการให้น้ำหนัก (weight) คะแนนจากแต่ละ Agent ตามที่ตั้งค่าไว้ และอาจมีการปรับค่าตาม "Bias" ของสินทรัพย์นั้นๆ
จัดการความเสี่ยง (Risk Management):
ถ้า "Final Verdict" เป็น "buy" หรือ "sell" ระบบจะนำข้อมูลเข้าสู่ Risk Manager
Risk Manager จะประเมินว่าควรเปิด position หรือไม่ โดยพิจารณาจาก:
มูลค่าพอร์ตโดยรวม
ความเสี่ยงที่ตั้งค่าไว้ต่อการเทรดหนึ่งครั้ง (RISK_PER_TRADE)
เปอร์เซ็นต์การตัดขาดทุน (STOP_LOSS_PERCENTAGE)
ขนาด position สูงสุดที่อนุญาต (MAX_POSITION_PERCENTAGE)
ราคาเข้าซื้อ และจุดตัดขาดทุนจาก Technical Agent (ถ้ามี)
หากการเทรดได้รับการอนุมัติ (approved), Risk Manager จะคำนวณขนาดของ position (จำนวนที่ต้องซื้อ/ขาย)
ส่งคำสั่งซื้อขาย (Execution):
ถ้าการเทรดได้รับการอนุมัติจาก Risk Manager, ระบบจะสร้างคำสั่งและส่งไปยัง Execution-Agent
Execution-Agent จะรับผิดชอบการส่งคำสั่งไปยังตลาดจริงๆ และคืนสถานะกลับมา (เช่น "PENDING", "PLACED")
วงจรการเรียนรู้ (Learning Feedback Loop):
ไม่ว่าการซื้อขายจะเกิดขึ้นหรือไม่, ระบบจะส่งข้อมูลผลลัพธ์ทั้งหมด (ข้อมูลวิเคราะห์, ผลการตัดสินใจของ Risk Manager, ผลการส่งคำสั่ง) ไปยัง Learning-Agent
Learning-Agent จะใช้ข้อมูลนี้เพื่อเรียนรู้และอาจจะมีการปรับเปลี่ยนนโยบายหรือพารามิเตอร์ต่างๆ (Policy Deltas) กลับมายัง Orchestrator เพื่อใช้ในการตัดสินใจครั้งต่อไป
ส่งผลลัพธ์กลับ: ระบบจะสร้าง Report สรุปผลการทำงานทั้งหมดและส่งกลับไปยังผู้เรียก
2. การวิเคราะห์หลายสินทรัพย์ (/analyze-multi)

Workflow นี้จะซับซ้อนขึ้นมาอีกระดับ โดยออกแบบมาเพื่อวิเคราะห์สินทรัพย์หลายตัวพร้อมกันและจัดการความเสี่ยงในระดับพอร์ตโฟลิโอ:

วิเคราะห์พร้อมกัน: ทำการวิเคราะห์สินทรัพย์แต่ละตัวตามขั้นตอนที่ 1-5 ของ /analyze พร้อมๆ กัน
จัดการความเสี่ยงระดับพอร์ต (Portfolio Risk Management):
นำผลการวิเคราะห์ของทุกสินทรัพย์ที่ "น่าสนใจ" (มี verdict เป็น buy/sell) เข้าสู่ Portfolio Risk Manager
ระบบจะประเมินภาพรวมของพอร์ต โดยพิจารณาจาก:
งบประมาณความเสี่ยงทั้งหมดสำหรับ Request นี้ (PER_REQUEST_RISK_BUDGET)
สัดส่วนความเสี่ยงรวมของพอร์ต (MAX_TOTAL_EXPOSURE)
และปัจจัยอื่นๆ ที่ใช้ใน assess_trade
Portfolio Risk Manager จะตัดสินใจว่าจะอนุมัติการเทรดตัวไหนบ้าง และจัดลำดับความสำคัญ เพื่อให้มั่นใจว่าความเสี่ยงโดยรวมไม่เกินที่กำหนด
ส่งคำสั่งซื้อขาย: ส่งคำสั่งซื้อขายสำหรับทุก trade ที่ได้รับการอนุมัติจาก Portfolio Risk Manager ไปยัง Execution-Agent พร้อมๆ กัน
สรุปผลและเรียนรู้: รวบรวมผลลัพธ์การซื้อขายทั้งหมด สร้างเป็น Report ใหญ่ และส่งข้อมูลการเทรดที่ "สำคัญที่สุด" (impactful) ไปให้ Learning-Agent เพื่อปรับปรุงนโยบายต่อไป
