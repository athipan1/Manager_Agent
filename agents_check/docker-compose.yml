version: '3.8'

services:
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: trading_user
      POSTGRES_PASSWORD: trading_password
      POSTGRES_MULTIPLE_DATABASES: database_agent_db,learning_agent_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh

  database-agent:
    build:
      context: ./Database_Agent
    ports:
      - "8001:8000"
    environment:
      DATABASE_AGENT_API_KEY: master_key
      POSTGRES_USER: trading_user
      POSTGRES_PASSWORD: trading_password
      POSTGRES_DB: database_agent_db
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
    depends_on:
      - db

  fundamental-agent:
    build:
      context: ./Fundamental_Agent
    ports:
      - "8002:8001"
    environment:
      FUNDAMENTAL_AGENT_API_KEY: master_key

  technical-agent:
    build:
      context: ./Technical_Agent
    ports:
      - "8003:8002"
    environment:
      TECHNICAL_AGENT_API_KEY: master_key
      PORT: 8002

  learning-agent:
    build:
      context: ./Learning_Agent
    ports:
      - "8004:8004"
    environment:
      LEARNING_AGENT_API_KEY: master_key
      DATABASE_URL: postgresql://trading_user:trading_password@db:5432/learning_agent_db
      DB_AGENT_URL: http://database-agent:8000
    depends_on:
      - db

  execution-agent:
    build:
      context: ./Execution_Agent
    ports:
      - "8005:8005"
    environment:
      EXECUTION_AGENT_API_KEY: master_key
      DB_AGENT_URL: http://database-agent:8000
      API_KEY: master_key
    depends_on:
      - database-agent

  scanner-agent:
    build:
      context: ./Scanner_Agent
    ports:
      - "8006:8000"
    environment:
      SCANNER_AGENT_API_KEY: master_key

  manager-agent:
    build:
      context: ./Manager_Agent
    ports:
      - "8000:80"
    environment:
      TECHNICAL_AGENT_URL: http://technical-agent:8002
      FUNDAMENTAL_AGENT_URL: http://fundamental-agent:8001
      DATABASE_AGENT_URL: http://database-agent:8000
      DATABASE_AGENT_API_KEY: master_key
      AUTO_LEARNING_AGENT_URL: http://learning-agent:8004
      EXECUTION_AGENT_URL: http://execution-agent:8005
      EXECUTION_API_KEY: master_key
      DEFAULT_ACCOUNT_ID: 1
    depends_on:
      - technical-agent
      - fundamental-agent
      - database-agent
      - learning-agent
      - execution-agent

volumes:
  postgres_data:
